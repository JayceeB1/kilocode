# Context digest for Supervisor UI components
# Files considered: 4
# Max chars per file: 4000
# Max chars per digest: 160000

===== webview-ui/src/components/settings/LocalSupervisor.tsx =====
import React, { useEffect, useState } from "react"
import { Cpu } from "lucide-react"
import { sendWithCompat } from "../../utils/vscode"
import type { SupervisorConfig } from "../../state/supervisorSlice"
import { SectionHeader } from "./SectionHeader"

const DEFAULTS: Partial<SupervisorConfig> = {
	bind: "127.0.0.1",
	port: 9611,
	allowLAN: false,
	allowedLANs: ["10.0.4.0/24"],
}

export default function LocalSupervisorSettings() {
	const [cfg, setCfg] = useState<SupervisorConfig | null>(null)
	const [saving, setSaving] = useState(false)
	const [error, setError] = useState<string | null>(null)
	const set = (k: keyof SupervisorConfig, v: any) => setCfg((prev) => (prev ? ({ ...prev, [k]: v } as any) : prev))

	useEffect(() => {
		;(async () => {
			try {
				const c = (await sendWithCompat("supervisor:get")) as SupervisorConfig
				setCfg({ ...DEFAULTS, ...c } as SupervisorConfig)
			} catch (e: any) {
				setError(e?.message ?? "Unable to load config")
			}
		})()
	}, [])

	async function save() {
		if (!cfg) return
		setSaving(true)
		setError(null)
		try {
			// validation UI simple
			if (cfg.bind === "0.0.0.0") throw new Error("0.0.0.0 est interdit")
			if (cfg.port < 9600 || cfg.port > 9699) throw new Error("Le port doit être entre 9600 et 9699")
			if (cfg.allowLAN && (!cfg.allowedLANs || cfg.allowedLANs.length === 0)) {
				throw new Error("Ajoutez au moins un réseau autorisé lorsque Allow LAN est activé")
			}
			const next = (await sendWithCompat("supervisor:set", cfg)) as SupervisorConfig
			setCfg(next)
		} catch (e: any) {
			setError(e?.message ?? "Save failed")
		} finally {
			setSaving(false)
		}
	}

	async function reset() {
		try {
			const fresh = (await sendWithCompat("supervisor:get")) as SupervisorConfig
			setCfg({ ...DEFAULTS, ...fresh } as SupervisorConfig)
			setError(null)
		} catch (e: any) {
			setError(e?.message ?? "Reset failed")
		}
	}

	if (!cfg) return <div>Loading…</div>

	return (
		<div className="p-4 space-y-3">
			<SectionHeader>
				<div className="flex items-center gap-2">
					<Cpu className="w-4" />
					<div>Local Supervisor</div>
				</div>
			</SectionHeader>
			{error && <div className="text-red-500 text-sm">{error}</div>}
			<div className="grid grid-cols-2 gap-3">
				<label className="flex items-center gap-2">
					<input type="checkbox" checked={cfg.enabled} onChange={(e) => set("enabled", e.target.checked)} />
					Enable
				</label>
				<label className="flex items-center gap-2">
					<input
						type="checkbox"
						checked={cfg.autoLaunch}
						onChange={(e) => set("autoLaunch", e.target.checked)}
					/>
					Auto-launch at app start
				</label>

				<div>
					<div className="text-sm font-medium">Bind</div>
					<select value={cfg.bind} onChange={(e) => set("bind", e.target.value)} className="w-full">
						<option value="127.0.0.1">127.0.0.1 (localhost)</option>
						<option value="10.0.4.70">10.0.4.70 (LAN)</option>
					</select>
				</div>
				<div>
					<div className="text-sm font-medium">Port (9600–9699)</div>
					<input
						type="number"
						min={9600}
						max={9699}
						value={cfg.port}
						onChange={(e) => set("port", Number(e.target.value))}
						className="w-full"
					/>
				</div>

				<div>
					<div className="text-sm font-medium">Provider</div>
					<select
						value={cfg.provider}
						onChange={(e) => set("provider", e.target.value as any)}
						className="w-full">
						<option value="ollama">Ollama</option>
						<option value="llama.cpp">llama.cpp</option>
					</select>
				</div>
				<div>
					<div className="text-sm font-medium">Endpoint</div>
					<input value={cfg.endpoint} onChange={(e) => set("endpoint", e.target.value)} className="w-full" />
				</div>

				<div>
					<div className="text-sm font-medium">Model</div>
					<input value={cfg.model} onChange={(e) => set("model", e.target.value)} className="w-full" />
				</div>
				<div>
					<div className="text-sm font-medium">Max tokens</div>
					<input
						type="
…[truncated]

# note: truncated to stay within per-file budget


===== webview-ui/src/components/settings/__tests__/LocalSupervisor.spec.tsx =====
import { describe, it, expect, beforeEach, vi } from "vitest"
import { render, screen, waitFor } from "@testing-library/react"
import userEvent from "@testing-library/user-event"
import { sendWithCompat, vscode } from "../../../utils/vscode"
import LocalSupervisorSettings from "../LocalSupervisor"
import type { SupervisorConfig } from "../../../state/supervisorSlice"

// Mock the vscode module
vi.mock("../../../utils/vscode", () => ({
	vscode: {
		postMessage: vi.fn(),
		getState: vi.fn(),
		setState: vi.fn(),
	},
	sendWithCompat: vi.fn(),
}))

// Default supervisor config for testing
const defaultConfig: SupervisorConfig = {
	version: 1,
	enabled: false,
	autoLaunch: false,
	bind: "127.0.0.1",
	port: 9611,
	provider: "ollama",
	endpoint: "http://127.0.0.1:11434",
	model: "llama3.1:8b-instruct-q4",
	max_tokens: 768,
	temperature: 0.2,
	redactLog: true,
	allowLAN: false,
	allowedLANs: ["10.0.4.0/24"],
}

describe("LocalSupervisorSettings", () => {
	const mockSendWithCompat = vi.mocked(sendWithCompat)
	const mockPostMessage = vi.mocked(vscode.postMessage)

	beforeEach(() => {
		vi.clearAllMocks()
		// Default mock implementation for successful operations
		mockSendWithCompat.mockResolvedValue(defaultConfig)
		mockPostMessage.mockImplementation(() => {})
	})

	it("renders the Local Supervisor settings form", async () => {
		render(<LocalSupervisorSettings />)

		await waitFor(() => {
			expect(screen.getByText("Local Supervisor")).toBeInTheDocument()
			expect(screen.getByLabelText("Enable")).toBeInTheDocument()
			expect(screen.getByLabelText("Auto-launch at app start")).toBeInTheDocument()
			// Allow LAN checkbox has a more complex label with a span inside
			expect(screen.getByText(/Allow LAN/)).toBeInTheDocument()
			expect(screen.getByDisplayValue("9611")).toBeInTheDocument()
			expect(screen.getByDisplayValue("http://127.0.0.1:11434")).toBeInTheDocument()
			expect(screen.getByDisplayValue("llama3.1:8b-instruct-q4")).toBeInTheDocument()
			expect(screen.getByDisplayValue("768")).toBeInTheDocument()
			expect(screen.getByDisplayValue("0.2")).toBeInTheDocument()
		})
	})

	it("saves configuration when Save button is clicked", async () => {
		const user = userEvent.setup()

		render(<LocalSupervisorSettings />)

		await waitFor(() => {
			expect(screen.getByText("Save")).toBeInTheDocument()
		})

		// Toggle the enable checkbox
		const enableCheckbox = screen.getByLabelText("Enable")
		await user.click(enableCheckbox)

		// Click save button
		const saveButton = screen.getByText("Save")
		await user.click(saveButton)

		// Check that supervisor:set was called with enabled: true
		await waitFor(() => {
			expect(mockSendWithCompat).toHaveBeenCalledWith(
				"supervisor:set",
				expect.objectContaining({
					enabled: true,
				}),
			)
		})
	})

	it("validates that port is within range 9600-9699", async () => {
		const user = userEvent.setup()

		render(<LocalSupervisorSettings />)

		await waitFor(() => {
			expect(screen.getByDisplayValue("9611")).toBeInTheDocument()
		})

		// Mock sendWithCompat to reject for invalid port
		mockSendWithCompat.mockImplementation((command) => {
			if (command === "supervisor:get") {
				return Promise.resolve(defaultConfig)
			}
			if (command === "supervisor:set") {
				return Promise.reject(new Error("The port should be between 9600 and 9699"))
			}
			return Promise.resolve({})
		})

		// Change port to invalid value by clicking and typing directly
		const portInput = screen.getByDisplayValue("9611")
		await user.click(portInput)
		await user.keyboard("{Control>}a{/Control}") // Select all
		await user.keyboard("9500")

		// Try to save
		const saveButton = screen.getByText("Save")
		await user.click(saveButton)

		// Should show error message
		await waitFor(
			() => {
				expect(screen.getByText(/The port should be between 9600 and 9699/)).toBeInTheDocument()
			},
			{ timeout: 3000 },
		)
	})

	it("displays error message when save fails", async () => {
		const user = userEvent.setu
…[truncated]

# note: truncated to stay within per-file budget


===== webview-ui/src/components/chat/ToolbarSupervisorToggle.tsx =====
import React from "react"
import { Zap } from "lucide-react"
import { useSupervisor } from "../../state/supervisorSlice"

export default function ToolbarSupervisorToggle() {
	const { enabled, setEnabled } = useSupervisor()
	return (
		<button
			title={enabled ? "Supervisor: ON (Ctrl+Alt+L)" : "Supervisor: OFF (Ctrl+Alt+L)"}
			onClick={() => setEnabled(!enabled)}
			className={
				"px-2 py-1 rounded text-sm flex items-center gap-1 " +
				(enabled ? "bg-green-600 text-white" : "bg-neutral-700 text-white")
			}
			aria-pressed={enabled}
			data-testid="toolbar-supervisor-toggle">
			<Zap className="w-3 h-3" />
			{enabled ? "SV ON" : "SV OFF"}
		</button>
	)
}


===== webview-ui/src/components/chat/__tests__/ToolbarSupervisorToggle.spec.tsx =====
import React from "react"
import { render, screen } from "@testing-library/react"
import userEvent from "@testing-library/user-event"
import { vi } from "vitest"
import ToolbarSupervisorToggle from "../ToolbarSupervisorToggle"
import { SupervisorProvider } from "../../../state/supervisorSlice"

// Mock the vscode utility
vi.mock("../../../utils/vscode", () => ({
	invoke: vi.fn(),
}))

describe("ToolbarSupervisorToggle", () => {
	const renderWithProvider = (component: React.ReactElement) => {
		return render(<SupervisorProvider>{component}</SupervisorProvider>)
	}

	it("renders the toggle button with SV OFF state initially", () => {
		renderWithProvider(<ToolbarSupervisorToggle />)

		const button = screen.getByTestId("toolbar-supervisor-toggle")
		expect(button).toBeInTheDocument()
		expect(button).toHaveTextContent("SV OFF")
		expect(button).toHaveAttribute("aria-pressed", "false")
		expect(button).toHaveAttribute("title", "Supervisor: OFF (Ctrl+Alt+L)")
	})

	it("toggles state when clicked", async () => {
		const user = userEvent.setup()
		renderWithProvider(<ToolbarSupervisorToggle />)

		const button = screen.getByTestId("toolbar-supervisor-toggle")

		// Initial state should be OFF
		expect(button).toHaveTextContent("SV OFF")
		expect(button).toHaveAttribute("aria-pressed", "false")

		// Click to toggle ON
		await user.click(button)

		// State should now be ON
		expect(button).toHaveTextContent("SV ON")
		expect(button).toHaveAttribute("aria-pressed", "true")
		expect(button).toHaveAttribute("title", "Supervisor: ON (Ctrl+Alt+L)")

		// Click to toggle OFF again
		await user.click(button)

		// State should be OFF again
		expect(button).toHaveTextContent("SV OFF")
		expect(button).toHaveAttribute("aria-pressed", "false")
		expect(button).toHaveAttribute("title", "Supervisor: OFF (Ctrl+Alt+L)")
	})

	it("has correct CSS classes based on state", async () => {
		const user = userEvent.setup()
		renderWithProvider(<ToolbarSupervisorToggle />)

		const button = screen.getByTestId("toolbar-supervisor-toggle")

		// Initial state (OFF) should have neutral background
		expect(button).toHaveClass("bg-neutral-700", "text-white")
		expect(button).not.toHaveClass("bg-green-600")

		// Toggle to ON
		await user.click(button)

		// ON state should have green background
		expect(button).toHaveClass("bg-green-600", "text-white")
		expect(button).not.toHaveClass("bg-neutral-700")
	})

	it("has correct accessibility attributes", () => {
		renderWithProvider(<ToolbarSupervisorToggle />)

		const button = screen.getByTestId("toolbar-supervisor-toggle")

		// Check for aria-pressed attribute
		expect(button).toHaveAttribute("aria-pressed")

		// Check for title attribute which includes keyboard shortcut
		expect(button).toHaveAttribute("title")
		expect(button.getAttribute("title")).toContain("Ctrl+Alt+L")
	})

	it("has data-testid for testing", () => {
		renderWithProvider(<ToolbarSupervisorToggle />)

		const button = screen.getByTestId("toolbar-supervisor-toggle")
		expect(button).toBeInTheDocument()
	})
})
